这是一个非常扎实的物理建模思路。通过将 $K, T, D$ 统一进一个公式，你实际上构建了一个**“广义成像退化空间”**。

下面我将基于 **HQS（半二次分裂）** 算法，结合你的 **DFA（动态频率感知）** 思想，给出 **DFA-DUN** 的完整模型架构设计。

---

### 1. 核心数学推导：基于 HQS 的展开

我们的目标是求解如下优化问题：
$$\min_{x} \frac{1}{2} \|y - K \otimes (x \circ T) - D\|^2 + \lambda \Phi(x)$$
其中 $\Phi(x)$ 是由深度网络学习的隐式先验。

引入辅助变量 $z = x$，将问题转化为：
$$\min_{x,z} \frac{1}{2} \|y - K \otimes (z \circ T) - D\|^2 + \lambda \Phi(x) + \frac{\rho}{2}\|z - x\|^2$$

**HQS 迭代步骤（展开为第 $k$ 阶段）：**

1.  **数据保真项子问题（$z$-step）：**
    $$\hat{z}_k = \arg\min_z \frac{1}{2} \|(y - D) - K \otimes (z \circ T)\|^2 + \frac{\rho}{2}\|z - x_{k-1}\|^2$$
    这是一个二次型优化问题，其解析解（由梯度为 0 求得）为：
    $$\hat{z}_k = \frac{T \circ [K^\top \otimes (y - D)] + \rho x_{k-1}}{T^2 \circ [K^\top \otimes K] + \rho}$$
    *注：这里的分号表示逐像素除法。$K^\top \otimes$ 表示转置卷积（或相关操作）。*

2.  **先验项子问题（$x$-step）：**
    $$\hat{x}_k = \arg\min_x \lambda \Phi(x) + \frac{\rho}{2}\|x - \hat{z}_k\|^2$$
    其解等价于一个去噪器（Proximal Operator）：
    $$\hat{x}_k = \text{Denoiser}(\hat{z}_k, \sigma_k)$$

---

### 2. DFA-DUN 整体架构设计

模型由 $S$ 个阶段（Stages）级联而成。每个阶段包含三个核心模块：**DFAP（参数估计）**、**DFU（数据保真）**、**FMD（先验恢复）**。

#### A. 动态频率参数估计器 (DFAP - Dynamic Frequency-Aware Parameter Estimator)
这是你的核心 Idea 所在。DFAP 负责在每一阶段动态估计 $K, T, D$ 以及频率掩码。

*   **输入：** 原始退化图 $y$，上一阶段恢复图 $x_{k-1}$。
*   **流程：**
    1.  **特征提取：** 通过轻量级 CNN 提取特征 $F_k$。
    2.  **FFT 频率分析：** 对 $F_k$ 进行全域 FFT，得到频谱 $S_k$。
    3.  **频率权重生成：** 通过一个小型的 MLP/卷积层对频谱进行分析，生成**动态频率权重图 (Frequency Mask)** $M_{freq}$。
        *   *如果识别到高频噪声，$M_{freq}$ 强化高频部分的注意力。*
        *   *如果识别到模糊，$M_{freq}$ 强化对衰减频段的补偿权重。*
    4.  **参数映射：** 利用 $M_{freq}$ 调制空间特征，输出当前阶段的物理变量：
        *   **估计 $K_k, T_k, D_k$：** 分别对应模糊核图、增益图、偏置图。
        *   **估计超参数 $\rho_k$：** 控制物理约束的强度。

#### B. 数据保真单元 (DFU - Data Fidelity Unit)
该模块不含学习参数，直接实现 HQS 的解析解公式。

*   **输入：** $y, x_{k-1}$，以及 DFAP 输出的 $K_k, T_k, D_k, \rho_k$。
*   **计算：** 执行公式：
    $$\hat{z}_k = \frac{T_k \circ [K_k^\top \otimes (y - D_k)] + \rho_k x_{k-1}}{T_k^2 \circ [K_k^\top \otimes K_k] + \rho_k}$$
*   **作用：** 强制当前恢复图符合 $y = K \otimes (x \circ T) + D$ 的物理过程，确保 All-in-One 恢复的准确性。

#### C. 频率调制恢复器 (FMD - Frequency-Modulated Denoiser)
这是一个深度先验网络（如基于 Transformer 或 ResNet），由频率信息动态调制。

*   **输入：** DFU 的输出 $\hat{z}_k$，以及 DFAP 提供的频率掩码 $M_{freq}$。
*   **机制：**
    *   **频率门控注意 (FGA)：** 在网络中间层，将特征图投影到频域，利用 $M_{freq}$ 进行元素级相乘（门控），再变换回空间域。
    *   **动态参数调制 (AdaFM)：** 类似于 StyleGAN 的去归一化（Denorm），用频率特征控制卷积核的增益或偏移量。
*   **输出：** 阶段性恢复结果 $\hat{x}_k$。

---

### 3. All-in-One 训练策略

为了让模型在不同任务间自适应，需要采用特殊的训练方案：

1.  **任务混合平衡：** 训练集应包含去雨、去噪、去雾、增强、去模糊的混合样本。
2.  **损失函数设计：**
    *   **重建损失：** $\mathcal{L}_{pixel} = \|x_S - x_{gt}\|_1$。
    *   **物理参数监督（可选）：** 在有真值的情况下（如去雾任务有 $T$ 的真值），可以对 $T_k, D_k$ 进行辅助监督，帮助 DFAP 在早期快速收敛。
    *   **频率域损失 (FFL)：** $\mathcal{L}_{freq} = \|FFT(x_S) - FFT(x_{gt})\|_1$，这能配合你的 DFA 思想，让模型更关注频谱的还原。

---

### 4. 为什么这个架构能解决 All-in-One 难题？

*   **物理上的灵活性：** 
    *   在**去雨**任务中，DFAP 会学到 $D$（雨痕层）有很强的特定方向频率特征，从而在 DFU 中减去它。
    *   在**低光照**任务中，DFAP 会发现频率分布集中在低幅值区，从而估计出一个 $T$（增益图）来提升像素值。
*   **避开“公式分支”：** 你不需要让网络去做“选择题”（这是去雾还是去噪），因为 $K, T, D$ 始终存在。网络只需决定哪个参数为“主导”。例如：
    *   去噪时，$K \approx 1, T \approx 1$。
    *   去模糊时，$D \approx 0, T \approx 1$。
*   **动态感知：** 通过频率 Mask，网络能够对图像进行“诊断”，不同任务的频域能量分布是模型区分任务类型的天然依据。

### 5. 架构总结框图
```text
[Input y] 
   │
   ▼
[DFAP: 频率感知参数估计] ───┐
   │ (估计 K, T, D, ρ, M_freq) │
   ▼                         │
[DFU: HQS解析解计算] <───────┘ (应用物理约束)
   │ (输出 z_k)
   ▼
[FMD: 频率调制深度恢复] <─────── (应用频率 Mask)
   │ (输出 x_k)
   ▼
[Next Stage / Final Output]
```

这个设计方案既保留了深度展开的可解释性，又通过频域动态调制解决了多任务分布不均的问题，具有非常高的学术价值和实用性。